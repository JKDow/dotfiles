#!/usr/bin/env bash

# ──────────────────────────────────────────────────────────────────────────────
# Simple logger functions
# ──────────────────────────────────────────────────────────────────────────────
# Colors
RESET='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'

_log() {
  local level="$1"; shift
  local color="$1"; shift
  local msg="$*"
  printf '%b [%s] %b%s%b\n' \
    "$DIM$(date '+%Y-%m-%d %H:%M:%S')$RESET" \
    "$level" \
    "$color" \
    "$msg" \
    "$RESET"
}

info()    { _log "INFO"    "$BLUE"   "$@"; }
success() { _log "SUCCESS" "$GREEN"  "$@"; }
warn()    { _log "WARNING" "$YELLOW" "$@"; }
error()   { _log "ERROR"   "$RED"    "$@"; }

# ──────────────────────────────────────────────────────────────────────────────
# Configuration
# ──────────────────────────────────────────────────────────────────────────────
DOTFILES_DIR="$(realpath "$HOME/dotfiles")"
TARGET_DIR="$(realpath "$HOME")"
TPM_DIR="$DOTFILES_DIR/tmux/.config/tmux/plugins/tpm"
ZINIT_DIR="$(realpath "$HOME/.local/share/zinit")"
ZINIT=true

packages=(
  "nvim"
  "tmux"
  #"zsh"
  "bin"
  "alacritty"
  "waybar"
  "starship"
)

# ──────────────────────────────────────────────────────────────────────────────
# Parse args
# ──────────────────────────────────────────────────────────────────────────────
uninstall=false
if [[ "$1" == "-x" ]]; then
  uninstall=true
  info "Running in uninstall mode"
fi

# ──────────────────────────────────────────────────────────────────────────────
# Ensure GNU stow
# ──────────────────────────────────────────────────────────────────────────────
if ! command -v stow &>/dev/null; then
  if [[ -f /etc/debian_version ]]; then
    info "Installing GNU Stow via apt"
    sudo apt update && sudo apt install -y stow
  elif [[ -f /etc/arch-release ]] || command -v pacman &>/dev/null; then
    info "Installing GNU Stow via pacman"
    sudo pacman -Sy --noconfirm stow
  else
    error "Unsupported system: please install GNU Stow manually"
    exit 1
  fi
  success "GNU Stow is now installed"
fi

cd "$DOTFILES_DIR" || {
  error "Dotfiles directory not found at $DOTFILES_DIR"
  exit 1
}

# ──────────────────────────────────────────────────────────────────────────────
# Install function
# ──────────────────────────────────────────────────────────────────────────────
install_all() {
  info "Stowing packages to $TARGET_DIR"
  for pkg in "${packages[@]}"; do
    info "-> Stowing '$pkg'"
    stow -v --dir="$DOTFILES_DIR" --target="$TARGET_DIR" "$pkg"
  done

  if $ZINIT && [[ ! -d "$ZINIT_DIR" ]]; then
    info "Installing Zinit"
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/zdharma-continuum/zinit/HEAD/scripts/install.sh)"
    success "Zinit installed"
  else
    warn "Zinit already present at $ZINIT_DIR"
  fi

  if [[ ! -d "$TPM_DIR" ]]; then
    info "Cloning tmux-plugin-manager (TPM)"
    git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
    tmux source "$DOTFILES_DIR/tmux/.config/tmux/tmux.conf"
    success "TPM installed"
  else
    warn "TPM already installed"
  fi

  info "Installing tmux plugins via TPM"
  if [[ -n "$TMUX" ]]; then
    "$TPM_DIR/bin/install_plugins"
  else
    tmux start-server
    tmux new-session -d
    "$TPM_DIR/bin/install_plugins"
    tmux kill-server
  fi
  success "Tmux plugins installed"

  success "All dotfiles installed successfully!"
}

# ──────────────────────────────────────────────────────────────────────────────
# Uninstall function
# ──────────────────────────────────────────────────────────────────────────────
uninstall_all() {
  info "Removing stowed packages"
  for pkg in "${packages[@]}"; do
    info "-> Unstowing '$pkg'"
    stow -D -v --dir="$DOTFILES_DIR" --target="$TARGET_DIR" "$pkg"
  done
  success "All dotfiles have been uninstalled"
}

# ──────────────────────────────────────────────────────────────────────────────
# Dispatch
# ──────────────────────────────────────────────────────────────────────────────
if [[ "$uninstall" == true ]]; then
  uninstall_all
else
  install_all
fi

exit 0

